{% extends "base.html" %}

{% block title %}Chat con {{ target_user.username }}{% endblock %}

{% block content %}
<div class="chat-container-wrapper">
    
    <div class="chat-header-card">
        <div class="header-info">
            <div class="avatar-circle">{{ target_user.username[0] | upper }}</div>
            <div>
                <h1>Chat de Soporte</h1>
                <p>Conversando con: <strong>{{ target_user.username }}</strong> (ID: {{ target_user.id }})</p>
            </div>
        </div>
        <div class="header-actions">
            <button id="end-chat-btn" class="btn-danger-sm">Finalizar Soporte</button>
            <a href="javascript:window.close();" class="btn-close-sm">Cerrar Ventana</a>
        </div>
    </div>

    <div class="chat-interface">
        <div id="chat-window" class="chat-messages-area">
            <div class="system-message">
                <small>Has iniciado una sesi贸n de soporte privado.</small>
            </div>
            </div>

        <form id="admin-chat-form" class="chat-input-area">
            <input type="text" id="message-input" placeholder="Escribe un mensaje al alumno..." required autocomplete="off">
            <button type="submit" class="btn-send">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>

</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const socket = io.connect(window.location.origin);
        
        // Asegurarse de que sean cadenas para la comparaci贸n
        const TARGET_USER_ID = "{{ target_user.id }}"; 
        const ADMIN_ID = "{{ current_user.id }}";
        const ADMIN_USERNAME = "{{ current_user.username }}";

        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('admin-chat-form');
        const messageInput = document.getElementById('message-input');
        const endChatBtn = document.getElementById('end-chat-btn');

        socket.on('connect', function() {
            console.log("Admin conectado al chat.");
            //  UNIRSE AL CANAL GLOBAL DE ADMINS PARA RECIBIR MENSAJES
            socket.emit('admin_join_pulse');
        });

        // 2. Recibir mensajes (Ahora vienen por el canal global)
        socket.on('admin_message_received', function(data) {
            console.log("Mensaje recibido:", data);
            
            //  FILTRO DE SEGURIDAD: Solo mostrar si viene del alumno actual
            // Convertimos a string ambos para asegurar que coincidan (ej. "2" == 2)
            if (String(data.sender_id) === String(TARGET_USER_ID)) {
                appendMessage(data.message, 'student', data.timestamp);
            }
        });

        // 3. Enviar mensajes al Alumno
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const msg = messageInput.value.trim();
            
            if (msg) {
                socket.emit('send_message_to_student', {
                    target_user_id: TARGET_USER_ID,
                    message: msg
                });
                appendMessage(msg, 'admin', new Date().toLocaleTimeString());
                messageInput.value = '';
            }
        });

        // ... (Resto del c贸digo igual: endChatBtn, appendMessage, etc.)
        endChatBtn.addEventListener('click', function() {
            if(confirm("驴Seguro que quieres finalizar la sesi贸n de soporte para este alumno?")) {
                socket.emit('close_student_chat_remote', {
                    target_user_id: TARGET_USER_ID,
                    admin_username: ADMIN_USERNAME
                });
                appendMessage("Has finalizado la sesi贸n de chat.", 'system');
                messageInput.disabled = true;
                endChatBtn.disabled = true;
            }
        });

        function appendMessage(text, type, time = '') {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message-bubble', type);
            let content = '';
            if (type === 'system') {
                content = `<small>${text}</small>`;
            } else {
                content = `<div class="msg-content">${text}</div><div class="msg-meta">${time}</div>`;
            }
            msgDiv.innerHTML = content;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    });
</script>

<style>
    body { background-color: #f0f2f5; } /* Fondo gris claro tipo WhatsApp Web */

    .chat-container-wrapper {
        max-width: 800px;
        margin: 20px auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 85vh; /* Ocupa casi toda la altura */
    }

    /* Header */
    .chat-header-card {
        background: #34495e;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
    }
    .header-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .header-info h1 { margin: 0; font-size: 1.2em; }
    .header-info p { margin: 0; font-size: 0.9em; opacity: 0.8; }
    
    .avatar-circle {
        width: 40px; height: 40px; background: #e67e22; color: white;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-weight: bold; font-size: 1.2em;
    }

    .header-actions .btn-danger-sm {
        background: #e74c3c; color: white; border: none; padding: 8px 12px;
        border-radius: 5px; cursor: pointer; font-size: 0.85em; margin-right: 10px;
    }
    .header-actions .btn-close-sm {
        color: #ecf0f1; text-decoration: none; font-size: 0.9em;
    }

    /* Ventana de Mensajes */
    .chat-interface {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }

    .chat-messages-area {
        flex-grow: 1;
        padding: 20px;
        overflow-y: auto;
        background-color: #e5ddd5; /* Color fondo tipo WhatsApp */
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* Burbujas de Chat */
    .message-bubble {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 10px;
        position: relative;
        font-size: 0.95em;
        line-height: 1.4;
    }
    
    .message-bubble.admin {
        align-self: flex-end;
        background-color: #dcf8c6; /* Verde claro (Mensaje propio) */
        color: #333;
        border-bottom-right-radius: 0;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .message-bubble.student {
        align-self: flex-start;
        background-color: #ffffff; /* Blanco (Mensaje recibido) */
        color: #333;
        border-bottom-left-radius: 0;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .message-bubble.system {
        align-self: center;
        background-color: rgba(255, 255, 255, 0.8);
        color: #555;
        font-style: italic;
        border-radius: 20px;
        padding: 5px 15px;
        font-size: 0.8em;
        margin: 10px 0;
    }

    .msg-meta {
        text-align: right;
        font-size: 0.7em;
        color: #999;
        margin-top: 4px;
    }

    /* Input Area */
    .chat-input-area {
        padding: 15px;
        background: #f0f0f0;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 10px;
    }
    .chat-input-area input {
        flex-grow: 1;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 25px;
        outline: none;
    }
    .btn-send {
        background: #3498db;
        color: white;
        border: none;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1em;
        transition: background 0.2s;
    }
    .btn-send:hover { background: #2980b9; }
</style>
{% endblock %}