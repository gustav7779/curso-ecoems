{% extends "base.html" %}

{% block title %}Detalle de Revisi√≥n de Examen{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/heatmap.js@2.0.2/build/heatmap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/style.css" />
<script src="https://cdn.jsdelivr.net/npm/rrweb-player@latest/dist/index.js"></script>

<div class="header-review-title">
    <h1>üîç Revisi√≥n Detallada: {{ exam.title }}</h1>
    <p>Alumno: <strong>{{ student.username }}</strong></p>
</div>

<div class="container review-container">
    
    <a href="{{ url_for('view_answers', exam_id=exam.id) }}" class="btn back-nav-btn">‚¨Ö Volver a Resultados</a>
    
    <div class="card summary-card">
        <h3 class="card-subtitle"><i class="fas fa-microscope"></i> Resumen de Calificaci√≥n y Rendimiento</h3>
        {% set result = result %} {% if result and result.score != -1.0 %}
            <div class="summary-grid">
                <div>
                    <strong>Puntaje Final:</strong>
                    <span class="summary-score">{{ result.score | int }} / {{ exam.questions | length }}</span>
                </div>
                <div>
                    <strong>Tipo de Env√≠o:</strong>
                    <span class="submission-tag tag-{{ result.submission_type }}">
                        {{ result.submission_type | capitalize | replace('_', ' ') }}
                    </span>
                </div>
                <div>
                    <strong>Fecha:</strong>
                    <span>{{ result.date_taken.strftime('%d/%m/%Y %H:%M') }}</span>
                </div>
            </div>
            <p class="data-status-info" id="data-status-info"></p>

            {% if result.session_recording %}
                <div style="margin-top: 25px; text-align: center; border-top: 1px dashed #ccc; padding-top: 15px;">
                    <button onclick="openReplayModal()" class="button" style="background: #e74c3c; color: white; padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                        <i class="fas fa-video"></i> üìπ Ver Repetici√≥n de Sesi√≥n (VAR)
                    </button>
                </div>
            {% endif %}

        {% else %}
            <p class="no-items-message" style="background-color: #f8d7da; border-left-color: #e74c3c; color: #721c24;">
                Este examen fue **CANCELADO** o no completado. No se gener√≥ calificaci√≥n.
            </p>
        {% endif %}
    </div>

    {% if review_data %}
        {% for question, answer in review_data %}
            <div class="question-card" id="q-{{ question.id }}">
                <h3 class="question-title">Pregunta {{ loop.index }}:</h3>
                
                <p class="question-text">{{ question.text }}</p>
                <p class="question-subject">Materia: <strong>{{ question.subject or 'General' }}</strong></p>

                {% if question.image_filename %}
                    <p class="image-label">Imagen de apoyo:</p>
                    <img src="{{ url_for('static', filename='images/' + question.image_filename) }}" 
                          alt="Imagen de apoyo para la pregunta" 
                          class="question-image">
                {% endif %}
                
                <div class="options-and-feedback">
                    <div class="options-group" id="options-group-{{ question.id }}">
                        <p><strong>Opciones:</strong></p>
                        
                        <div class="heatmap-overlay-area" id="heatmap-area-{{ question.id }}">
                            
                            {% for letter in ['A', 'B', 'C', 'D'] %}
                                {% set option_text = question['option_' + letter.lower()] %}
                                {% if option_text %}
                                    
                                    {% set is_correct = (letter == question.correct_option) %}
                                    {% set is_student_choice = (answer and letter == answer.response) %}
                                    
                                    <div class="option-item 
                                        {% if is_correct %}correct-option-bg{% endif %}
                                        {% if is_student_choice and not is_correct %}wrong-response-bg{% endif %}
                                        {% if is_student_choice and is_correct %}correct-response-bg{% endif %}
                                        " data-option-id="{{ letter }}">
                                        
                                        <span class="option-letter">{{ letter }})</span>
                                        <span class="option-text">{{ option_text }}</span>
                                        
                                        {% if is_correct %}
                                            <span class="correct-mark"> (Correcta)</span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <div class="student-response-info">
                        <h4>Resultado y Timing:</h4>
                        <p class="response-display">
                            <strong>Respuesta:</strong> 
                            <span class="response-choice-text">{{ answer.response if answer else '--- Sin Responder ---' }}</span>
                        </p>

                        <p class="grade-display">
                            {% if answer and answer.grade == 1.0 %}
                                <span class="grade-correct">‚úÖ Correcto (1.0/1.0)</span>
                            {% elif answer and answer.grade == 0.0 %}
                                <span class="grade-incorrect">‚ùå Incorrecto (0.0/1.0)</span>
                            {% else %}
                                <span class="grade-manual">‚ö†Ô∏è Sin Respuesta</span>
                            {% endif %}
                        </p>
                        
                        <hr class="timing-separator">

                        <div class="timing-box">
                            <h4 class="timing-title">‚è≤Ô∏è Tiempo en esta Pregunta:</h4>
                            <p class="timing-display" id="timing-{{ question.id }}">--</p>
                            <div class="timing-comparison-bar">
                                <div class="timing-bar-fill" id="bar-fill-{{ question.id }}"></div>
                            </div>
                            <small class="comparison-text">Tiempo promedio: <span id="avg-time-display">--</span> segundos</small>
                        </div>
                        
                        {% if answer and answer.feedback %}
                            <p class="feedback-box"><strong>Feedback:</strong> {{ answer.feedback }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p class="no-items-message">Este alumno no ha tomado o no ha respondido a ninguna pregunta de este examen.</p>
    {% endif %}

    <a href="{{ url_for('view_answers', exam_id=exam.id) }}" class="btn back-nav-btn">‚¨Ö Volver a Resultados</a>
</div>

<div id="replay-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content-player">
        <div class="modal-header">
            <h3>üé• Replay del Examen</h3>
            <button onclick="closeReplayModal()" class="close-modal-btn">Cerrar X</button>
        </div>
        <div id="replay-container" class="replay-container"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Datos del servidor (ya analizados)
        const resultData = {{ result | tojson }};
        const proctoringDataRaw = resultData.proctoring_data;
        const allQuestions = document.querySelectorAll('.question-card');
        
        let timeData = {};
        let clickData = [];
        let totalTimeSpent = 0;
        let averageTimePerQuestion = 0;

        // 1. Cargar y parsear JSON de Proctoring
        if (proctoringDataRaw && typeof proctoringDataRaw === 'string') {
            try {
                const parsedData = JSON.parse(proctoringDataRaw);
                timeData = parsedData.time_data || {};
                clickData = parsedData.click_data || [];
                
                const totalTimeValues = Object.values(timeData);
                if (totalTimeValues.length > 0) {
                    totalTimeSpent = totalTimeValues.reduce((a, b) => a + b, 0);
                    averageTimePerQuestion = totalTimeSpent / allQuestions.length;
                }
            } catch (e) {
                document.getElementById('data-status-info').textContent = "‚ùå Error: Datos de proctoring corruptos o incompletos.";
                return;
            }
        }
        
        // Muestra el estado de la carga de datos
        document.getElementById('data-status-info').textContent = 
            totalTimeSpent > 0 ? `‚úÖ Data de ${Object.keys(timeData).length} preguntas cargada. Tiempo total: ${totalTimeSpent.toFixed(0)}s` 
            : `‚ö†Ô∏è Data de proctoring no disponible.`;
        
        // Actualizar el tiempo promedio global
        document.getElementById('avg-time-display').textContent = averageTimePerQuestion.toFixed(1);


        // --- 2. RENDERIZAR TIEMPO Y MAPA DE CALOR POR PREGUNTA ---
        allQuestions.forEach(card => {
            const qid = card.id.replace('q-', '');
            const qTime = timeData[qid] || 0;
            const qClicks = clickData.filter(click => click.qid === qid);
            
            const timeDisplay = document.getElementById(`timing-${qid}`);
            const barFill = card.querySelector('.timing-bar-fill');
            const optionsGroup = document.getElementById(`options-group-${qid}`);

            // a) Display Time Spent (Timing)
            if (timeDisplay) {
                const qTimeFormatted = qTime.toFixed(1);
                timeDisplay.textContent = `${qTimeFormatted} segundos`;

                // Calcular la ratio de comparaci√≥n (m√°ximo 2.0x para visualizaci√≥n)
                let comparisonRatio = averageTimePerQuestion > 0 ? qTime / averageTimePerQuestion : 0;
                if (comparisonRatio > 2) comparisonRatio = 2.0; 
                
                if (barFill) {
                    barFill.style.width = `${comparisonRatio * 50}%`; 
                    if (comparisonRatio >= 1.5) { barFill.style.backgroundColor = '#e74c3c'; } // Lento: Rojo
                    else if (comparisonRatio <= 0.5 && comparisonRatio > 0) { barFill.style.backgroundColor = '#f39c12'; } // R√°pido: Amarillo
                    else { barFill.style.backgroundColor = '#2ecc71'; } // Normal: Verde
                }
            }
            
            // b) Renderizar Heatmap (Clicks)
            const heatmapArea = document.getElementById(`heatmap-area-${qid}`);
            if (heatmapArea && qClicks.length > 0) {
                
                // 1. Re-mapear clicks a coordenadas relativas al optionsGroup
                const containerRect = optionsGroup.getBoundingClientRect();

                const heatmapData = qClicks.map(c => ({
                    // Remapear coordenadas al inicio del contenedor de opciones (options-group)
                    x: Math.round(c.x - containerRect.left),
                    y: Math.round(c.y - containerRect.top),
                    value: 1 // Cada click suma 1
                }));

                // 2. Inicializar Heatmap
                const heatmapInstance = h337.create({
                    container: heatmapArea,
                    radius: 25, // Tama√±o de los puntos de calor
                    maxOpacity: .7,
                    minOpacity: 0,
                    blur: .75
                });

                heatmapInstance.setData({
                    max: 1, // El valor m√°ximo de la celda de la cuadr√≠cula es 1
                    data: heatmapData
                });

                // Establecer el contenedor de Heatmap para que se superponga
                heatmapArea.style.position = 'relative'; // El canvas estar√° dentro
                heatmapArea.style.width = containerRect.width + 'px';
                heatmapArea.style.height = containerRect.height + 'px';
                heatmapArea.style.pointerEvents = 'none'; 
            }
        });
        
    });

    // üî• L√ìGICA DEL REPRODUCTOR (VAR) üî•
    const recordingDataRaw = {{ result.session_recording | tojson }};

    function openReplayModal() {
        document.getElementById('replay-modal').style.display = 'flex';
        
        if (recordingDataRaw) {
            try {
                const events = JSON.parse(recordingDataRaw);
                const container = document.getElementById('replay-container');
                container.innerHTML = ''; // Limpiar previo

                // Instanciar RRweb Player
                new rrwebPlayer({
                    target: container,
                    props: {
                        events,
                        width: container.clientWidth, // Ancho din√°mico del contenedor
                        height: container.clientHeight, // Alto din√°mico
                        autoPlay: true,
                        showController: true,
                    },
                });
            } catch(e) {
                alert("Error al cargar la grabaci√≥n: Datos corruptos.");
                console.error(e);
            }
        } else {
            alert("No hay datos de grabaci√≥n disponibles.");
        }
    }

    function closeReplayModal() {
        document.getElementById('replay-modal').style.display = 'none';
        document.getElementById('replay-container').innerHTML = ''; // Detener y limpiar player
    }
</script>

<style>
    /* --- T√≠tulo de la P√°gina --- */
    .header-review-title {
        background: linear-gradient(90deg, #34495e, #2c3e50); /* Color Admin */
        color: white; 
        padding: 25px;
        text-align: center; 
        border-radius: 0 0 10px 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .header-review-title h1, .header-review-title p { margin: 0; }
    
    .data-status-info { color: #fff; font-size: 0.9em; margin-top: 10px; }

    /* --- Contenedor Principal (Centrado) --- */
    .review-container { max-width: 950px; margin: 20px auto; }
    
    .back-nav-btn {
        background: #7f8c8d; padding: 10px 15px; margin-bottom: 20px; transition: background 0.3s, transform 0.2s;
        display: inline-block;
    }
    .back-nav-btn:hover { background: #5c6a74; transform: translateX(-3px); }

    /* --- Tarjeta de Resumen --- */
    .summary-card {
        background: #fdfae5; border: 1px solid #f39c12; padding: 25px; margin-bottom: 25px; border-radius: 10px;
    }
    .summary-card .card-subtitle { margin-top: 0; color: #34495e; font-size: 1.4em; }
    .summary-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; font-size: 1.1em;
    }
    .summary-grid strong { display: block; font-size: 0.9em; margin-bottom: 5px; color: #34495e; }
    .summary-score { font-size: 1.5em; font-weight: bold; color: #3498db; }
    .submission-tag { padding: 5px 10px; border-radius: 5px; font-size: 0.9em; font-weight: bold; color: white; }
    .tag-manual { background: #2ecc71; }
    .tag-auto { background: #f39c12; }
    .tag-manual_cancel, .tag-auto_cancel { background: #e74c3c; }

    /* --- Tarjeta de Pregunta --- */
    .question-card {
        background: white; padding: 25px; margin-bottom: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-left: 5px solid #3498db;
    }
    .question-title { font-size: 1.4em; color: #34495e; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
    .question-text { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; }
    .question-subject { font-size: 0.9em; color: #7f8c8d; margin-bottom: 15px; }
    .question-image { max-width: 100%; height: auto; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.15); margin-top: 10px; }


    /* --- Grupo de Opciones y Feedback (FLEX) --- */
    .options-and-feedback { display: flex; gap: 20px; margin-top: 20px; }

    .options-group { flex: 1; padding: 15px; border-radius: 8px; background: #f8fbfc; border: 1px solid #f0f0f0; }
    .student-response-info { flex: 1; padding: 15px; border-radius: 8px; background: #fdf3c7; border: 1px solid #f1c40f; }
    
    .student-response-info h4 { font-size: 1.1em; color: #2c3e50; margin-top: 0; border-bottom: 1px dashed #ddd; padding-bottom: 5px; margin-bottom: 10px; }

    /* üî• HEATMAP OVERLAY AREA üî• */
    .heatmap-overlay-area { 
        position: relative; /* CLAVE para que el canvas de heatmap se superponga */
    }
    .option-item { padding: 8px 12px; margin-bottom: 8px; border-radius: 5px; display: flex; align-items: flex-start; font-size: 0.95em; border: 1px solid transparent; }
    .option-letter { font-weight: bold; margin-right: 10px; flex-shrink: 0; }
    
    /* --- Colores de Fondo de las Opciones --- */
    .correct-option-bg { background: #d4edda; border: 1px solid #2ecc71; font-weight: bold; }
    .wrong-response-bg { background: #f8d7da; border: 1px solid #e74c3c; font-weight: bold; text-decoration: line-through; }
    .correct-response-bg { background: #2ecc71; color: white; border: 1px solid #27ae60; font-weight: bold; }
    
    /* --- Visualizaci√≥n de Calificaci√≥n --- */
    .response-display { font-size: 1.1em; color: #34495e; }
    .grade-display { margin-top: 15px; font-weight: bold; }
    .grade-correct { color: #2ecc71; font-size: 1.1em; }
    .grade-incorrect { color: #e74c3c; font-size: 1.1em; }
    .grade-manual { color: #f1c40f; font-size: 1.1em; }

    .feedback-box { border-top: 1px dashed #f1c40f; padding-top: 10px; margin-top: 10px; font-size: 0.9em; color: #555; background: #fff; padding: 10px; border-radius: 5px; }

    .no-items-message { padding: 15px; background: #fdf3c7; border-left: 5px solid #f1c40f; border-radius: 5px; margin-top: 15px; font-weight: bold; }

    /* --- TIMING BAR STYLES --- */
    .timing-box { text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #f0f0f0; }
    .timing-title { color: #3498db; font-size: 1.1em; margin-bottom: 10px; }
    .timing-display { font-size: 1.5em; font-weight: 700; margin-bottom: 5px; color: #2c3e50; }

    .timing-comparison-bar {
        width: 90%;
        height: 10px;
        background: #ecf0f1;
        border-radius: 5px;
        overflow: hidden;
        margin: 10px auto;
    }
    .timing-bar-fill {
        height: 100%;
        width: 0;
        background-color: #2ecc71; /* Default/Normal */
        transition: width 1s ease-out;
    }
    .comparison-text {
        color: #7f8c8d;
        font-size: 0.85em;
        display: block;
    }

    /* üî• ESTILOS DEL MODAL DEL REPRODUCTOR üî• */
    .modal-overlay { 
        position: fixed; top:0; left:0; width:100%; height:100%; 
        background:rgba(0,0,0,0.85); z-index:10000; 
        display: flex; justify-content:center; align-items:center; 
    }
    .modal-content-player { 
        background: white; 
        padding: 0; 
        border-radius: 8px; 
        width: 95%; 
        height: 90%; 
        max-width: 1200px; 
        display: flex; 
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .modal-header {
        padding: 15px;
        background: #f5f5f5;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .close-modal-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 5px 15px;
        cursor: pointer;
        border-radius: 4px;
        font-weight: bold;
    }
    .replay-container {
        flex-grow: 1;
        background: #eee;
        /* El player de RRWEB llenar√° este espacio */
    }

    /* --- MEDIA QUERY (M√≥vil) --- */
    @media (max-width: 768px) {
        .review-container { width: 100%; padding: 0 10px; }
        .question-card { padding: 15px; }
        .options-and-feedback { flex-direction: column; gap: 15px; }
        .student-response-info { order: -1; }
        .back-nav-btn { width: 100%; text-align: center; transform: none; }
        .timing-box { padding-top: 10px; margin-top: 15px; }
    }
</style>
{% endblock %}